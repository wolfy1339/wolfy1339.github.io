/*Orteil's crappy dungeon generation library, 2013. unfinished and buggy, use at your own risk (please credit) Rough process (might or might not be what actually happens) :
1 make a room in the middle
2 pick one of its walls (not corners)
3 select a free tile on the other side of that wall
4 iteratively expand the selection in one (corridors) or two (rooms) directions, stopping when we meet a wall or when we're above the size threshold
5 compute that selection into a room
6 add decorations to the room (pillars, water) but only on the center tiles, as to leave free passages (sprinkle destructible decorations anywhere)
7 take a random floor tile in the room and repeat step 4, but don't stop at the walls of this room (this creates branching) - repeat about 5 times for interesting shapes
8 add those branches to the room
9 carve the room into the map, and set the initially selected wall as a door - set the new room's parent to the previous room, and add it to its parent's children
10 repeat step 2 with any free wall on the map until the amount of tiles dug is above the desired fill ratio
Note : I should probably switch the rendering to canvas to allow stuff like occlusion shadows and lights*/
if(1==1||undefined==Math.seedrandom){(function(e,t,n,r,i,s){function o(e){var t,n=e.length,i=this,s=0,o=i.i=i.j=0,u=i.S=[];for(n||(e=[n++]);r>s;)u[s]=s++;for(s=0;r>s;s++)u[s]=u[o=d&o+e[s%n]+(t=u[s])],u[o]=t;(i.g=function(e){for(var t,n=0,s=i.i,o=i.j,u=i.S;e--;)t=u[s=d&s+1],n=n*r+u[d&(u[s]=u[o=d&o+t])+(u[o]=t)];return i.i=s,i.j=o,n})(r)}function u(e,t){var n,r=[],i=(typeof e)[0];if(t&&"o"==i)for(n in e)try{r.push(u(e[n],t-1))}catch(s){}return r.length?r:"s"==i?e:e+"\0"}function a(e,t){for(var n,r=e+"",i=0;r.length>i;)t[d&i]=d&(n^=19*t[d&i])+r.charCodeAt(i++);return l(t)}function f(n){try{return e.crypto.getRandomValues(n=new Uint8Array(r)),l(n)}catch(i){return[+(new Date),e,e.navigator.plugins,e.screen,l(t)]}}function l(e){return String.fromCharCode.apply(0,e)}var c=n.pow(r,i),h=n.pow(2,s),p=2*h,d=r-1;n.seedrandom=function(e,s){var d=[],v=a(u(s?[e,l(t)]:0 in arguments?e:f(),3),d),y=new o(d);return a(l(y.S),t),n.random=function(){for(var e=y.g(i),t=c,n=0;h>e;)e=(e+n)*r,t*=r,n=y.g(1);for(;e>=p;)e/=2,t/=2,n>>>=1;return(e+n)/t},v},a(n.random(),t)})(this,[],Math,256,6,52)}if(1==1||undefined==choose){function choose(e){if(e.length==0)return 0;else return e[Math.floor(Math.random()*e.length)]}}var DungeonGen=function(){var e=0;var t=-100;var n=100;var r=110;var i=200;var s=300;var o=400;var u=500;var a=510;var f=250;var l=260;var c=[];c[e]="000";c[t]="900";c[n]="ffc";c[r]="ff9";c[i]="f9f";c[s]="990";c[o]="99f";c[u]="960";c[a]="630";c[f]="f9f";c[l]="f9f";var h=function(e,t){return Math.floor(Math.random()*(t-e+1)+e)};var p=[];this.Pattern=function(e,t){this.name=e;this.func=t;p.push(this)};new this.Pattern("Pillars",function(e,t,n){if((e+n.x)%2==0&&(t+n.y)%2==0&&Math.random()<.8)return s;return 0});new this.Pattern("Large pillars",function(e,t,n){if((e+n.x)%3<2&&(t+n.y)%3<2&&Math.random()<.8)return s;return 0});new this.Pattern("Sparse pillars",function(e,t,n){if((e+n.x)%3==0&&(t+n.y)%3==0&&Math.random()<.8)return s;return 0});new this.Pattern("Lines",function(e,t,n){if(n.x%2==0)if((e+n.x)%2==0&&Math.random()<.98)return s;if(n.x%2==1)if((t+n.y)%2==0&&Math.random()<.98)return s;return 0});var d=function(){return choose(p)};var v=function(e){e.roomSize=10;e.corridorSize=5;e.fillRatio=1/3;e.corridorRatio=.2;e.pillarRatio=.2;e.waterRatio=0;e.branching=4;e.sizeVariance=.2;e.fillRatio=.1+Math.random()*.4;e.roomSize=Math.ceil(h(5,15)*e.fillRatio*2);e.corridorSize=Math.ceil(h(1,7)*e.fillRatio*2);e.corridorRatio=Math.random()*.8+.1;e.pillarRatio=Math.random()*.5+.5;e.waterRatio=Math.pow(Math.random(),2);e.branching=Math.floor(Math.random()*6);e.sizeVariance=Math.random()};this.Map=function(n,r,i,s){if(undefined!=i)this.seed=i;else{Math.seedrandom();this.seed=Math.random()}Math.seedrandom(this.seed);this.seedState=Math.random;this.w=n||20;this.h=r||20;this.roomsAreHidden=0;this.rooms=[];this.freeWalls=[];this.freeTiles=[];this.doors=[];this.tiles=this.w*this.h;this.tilesDug=0;this.digs=0;this.stuck=0;this.data=[];for(var o=0;o<this.w;o++){this.data[o]=[];for(var u=0;u<this.h;u++){this.data[o][u]=[e,-1,0];if(o==0||u==0||o==this.w-1||u==this.h-1)this.data[o][u]=[t,-1,0]}}v(this);if(s){for(var a in s){this[a]=s[a]}}Math.seedrandom()};this.Map.prototype.getType=function(e,t){return this.data[e][t][0]};this.Map.prototype.getRoom=function(e,t){if(this.data[e][t][1]!=-1)return this.rooms[this.data[e][t][1]];else return-1};this.Map.prototype.getTile=function(e,t){return this.rooms[this.data[e][t][2]]};this.Map.prototype.isWall=function(e,t){var n=0;for(var r in this.freeWalls){if(this.freeWalls[r][0]==e&&this.freeWalls[r][1]==t)return n;else n++}return-1};this.Map.prototype.isFloor=function(e,t){var n=0;for(var r in this.freeTiles){if(this.freeTiles[r][0]==e&&this.freeTiles[r][1]==t)return n;else n++}return-1};this.Map.prototype.removeFreeTile=function(e,t){this.freeTiles.splice(this.isFloor(e,t),1)};this.Map.prototype.fill=function(e){var t=0;if(typeof e=="function")t=1;for(var n=0;n<this.w;n++){for(var r=0;r<this.h;r++){if(t)this.data[n][r]=[e(this,n,r),-1,0];else this.data[n][r]=[e,-1,0]}}this.rooms=[]};this.Map.prototype.fillZone=function(e,t,n,r,i){for(var s=e;s<e+n;s++){for(var o=t;o<t+r;o++){this.data[s][o][0]=i}}};this.Map.prototype.getRoomTile=function(e,t,n){var r=0;for(var i in e.tiles){if(e.tiles[i].x==t&&e.tiles[i].y==n)return r;else r++}return-1};this.Map.prototype.getFloorTileInRoom=function(e){var t=[];for(var i in e.tiles){if(e.tiles[i].type==n||e.tiles[i].type==r)t.push(e.tiles[i])}return choose(t)};this.Map.prototype.canPlaceRoom=function(e,n,r,i){if(e<2||n<2||e+r>=this.w-1||n+i>=this.h-1)return false;for(var s=e;s<e+r;s++){for(var o=n;o<n+i;o++){var u=this.getType(s,o);var a=this.getRoom(s,o);if(u==t)return false;if(a!=-1)return false}}return true};this.Map.prototype.setRoomTile=function(e,t,i,s){var o=this.getRoomTile(e,t,i);var f=o!=-1?e.tiles[o].type:-1;if(o!=-1&&(s==u||s==a||s==n&&f==r)){return false}else{if(o!=-1)e.tiles.splice(o,1);e.tiles.push({x:t,y:i,type:s,score:0});if((s==n||s==r)&&f!=n&&f!=r)e.freeTiles++;else if(s!=n&&s!=r&&(f==n||f==r))e.freeTiles--;return true}};this.Map.prototype.expandRoom=function(e,t,i,s,f){var l=0;var c=0;for(var l=t;l<t+s;l++){for(var c=i;c<i+f;c++){this.setRoomTile(e,l,c,n)}}for(var l=t+1;l<t+s-1;l++){for(var c=i+1;c<i+f-1;c++){this.setRoomTile(e,l,c,r)}}c=i-1;for(var l=t;l<t+s;l++){this.setRoomTile(e,l,c,u)}c=i+f;for(var l=t;l<t+s;l++){this.setRoomTile(e,l,c,u)}l=t-1;for(var c=i;c<i+f;c++){this.setRoomTile(e,l,c,u)}l=t+s;for(var c=i;c<i+f;c++){this.setRoomTile(e,l,c,u)}l=t-1;c=i-1;this.setRoomTile(e,l,c,a);l=t+s;c=i-1;this.setRoomTile(e,l,c,a);l=t-1;c=i+f;this.setRoomTile(e,l,c,a);l=t+s;c=i+f;this.setRoomTile(e,l,c,a);var h=Math.random()<this.waterRatio?1:0;var p=Math.random()<this.pillarRatio?d():0;for(var l=t;l<t+s;l++){for(var c=i;c<i+f;c++){if(e.tiles[this.getRoomTile(e,l,c)].type==r){var v=0;if(h!=0)v=o;if(p!=0){v=p.func(l,c,e)||v}if(v!=0)this.setRoomTile(e,l,c,v)}}}};this.Map.prototype.newRoom=function(e,t,n,r,i){var s={};s.id=this.rooms.length;s.w=n;s.h=r;s.x=e||h(1,this.w-s.w-1);s.y=t||h(1,this.h-s.h-1);s.tiles=[];s.freeTiles=0;s.parent=i?i:-1;s.children=[];s.gen=0;s.door=0;s.corridor=Math.random()<this.corridorRatio?1:0;s.hidden=this.roomsAreHidden;return s};this.Map.prototype.planRoom=function(e){var t=this.branching+1;var n=[];var r=e.w;var i=e.h;while(r>0&&i>0){if(r>0){n.push(1,3);r--}if(i>0){n.push(2,4);i--}}for(var s=0;s<t;s++){var o=0;var u=[];if(!e.corridor){u=[1,2,3,4];o=this.roomSize}else{u=choose([[1,3],[2,4]]);o=this.corridorSize}o=Math.max(e.w+e.h,Math.ceil(o*(1-Math.random()*this.sizeVariance)));if(e.tiles.length==0){var a=e.x;var f=e.y;var l=1;var c=1}else{var h=this.getFloorTileInRoom(e);var a=h.x;var f=h.y;var l=1;var c=1}for(var p=0;p<o;p++){if(u.length==0)break;var d=0;var v=0;var m=0;var g=0;var y=choose(u);if(n.length>0)y=n[0];if(y==1){d=-1;m=1}else if(y==2){v=-1;g=1}else if(y==3){m=1}else if(y==4){g=1}if(this.canPlaceRoom(a+d,f+v,l+m,c+g)){a+=d;f+=v;l+=m;c+=g}else u.splice(u.indexOf(y),1);if(n.length>0)n.splice(0,1)}if(l>1||c>1){this.expandRoom(e,a,f,l,c)}}};this.Map.prototype.carve=function(e){for(var t in e.tiles){var i=e.tiles[t];var s=i.x;var o=i.y;var f=this.data[s][o][0];var l=i.type;if((l==u||l==a)&&this.isWall(s,o)!=-1){this.freeWalls.splice(this.isWall(s,o),1)}if(this.data[s][o][1]!=-1&&(l==u||l==a)){}else{if(this.data[s][o][1]==-1)this.tilesDug++;this.data[s][o]=[i.type,e.id,0];if(s>1&&o>1&&s<this.w-2&&o<this.h-2&&l==u)this.freeWalls.push([s,o]);if(l==n||l==r)this.freeTiles.push([s,o])}var c=[s,o]}this.rooms[e.id]=e};this.Map.prototype.newRandomRoom=function(t){var n=1;t=t||{};var r=choose(this.freeWalls);if(!r){n=0}else{var s=this.getRoom(r[0],r[1]);var o=[];if(this.getType(r[0]-1,r[1])==e)o.push([-1,0]);if(this.getType(r[0]+1,r[1])==e)o.push([1,0]);if(this.getType(r[0],r[1]-1)==e)o.push([0,-1]);if(this.getType(r[0],r[1]+1)==e)o.push([0,1]);var u=choose(o);if(!u){n=0;this.freeWalls.splice(this.isWall(r[0],r[1]),1)}else{var a=this.newRoom(r[0]+u[0],r[1]+u[1],0,0,s);for(var f in t){a[f]=t[f]}this.planRoom(a);if(a.tiles.length>0&&a.freeTiles>0){this.carve(a);this.data[r[0]][r[1]][0]=i;a.door=[r[0],r[1]];this.data[r[0]][r[1]][1]=a.id;this.freeWalls.splice(this.isWall(r[0],r[1]),1);this.doors.push([r[0],r[1],a]);if(this.isFloor(r[0]+u[0],r[1]+u[1])!=-1)this.removeFreeTile(r[0]+u[0],r[1]+u[1]);if(this.isFloor(r[0]-u[0],r[1]-u[1])!=-1)this.removeFreeTile(r[0]-u[0],r[1]-u[1]);a.parent=s;s.children.push(a);a.gen=s.gen+1}else{this.freeWalls.splice(this.isWall(r[0],r[1]),1);n=0}}}if(n)return a;else return 0};this.Map.prototype.getRandomSpotInRoom=function(e){var t=[];for(var i in e.tiles){if((e.tiles[i].type==n||e.tiles[i].type==r)&&this.isFloor(e.tiles[i].x,e.tiles[i].y)!=-1){t.push(e.tiles[i])}}if(t.length==0)return-1;return choose(t)};this.Map.prototype.getBestSpotInRoom=function(e){var t=-1;var i=[];for(var s in e.tiles){if((e.tiles[s].type==n||e.tiles[s].type==r)&&this.isFloor(e.tiles[s].x,e.tiles[s].y)!=-1){if(e.tiles[s].score>t){i=[];t=e.tiles[s].score;i.push(e.tiles[s])}else if(e.tiles[s].score==t){i.push(e.tiles[s])}}}if(i.length==0)return-1;return choose(i)};this.Map.prototype.getEarliestRoom=function(){return this.rooms[0]};this.Map.prototype.getDeepestRoom=function(){var e=0;var t=this.rooms[0];for(var n in this.rooms){if(this.rooms[n].gen+Math.sqrt(this.rooms[n].freeTiles)*.05>=e&&this.rooms[n].corridor==0&&this.rooms[n].freeTiles>4){e=this.rooms[n].gen+Math.sqrt(this.rooms[n].freeTiles)*.05;t=this.rooms[n]}}return t};this.Map.prototype.dig=function(){Math.random=this.seedState;var e=0;if(this.digs==0){var t=h(3,7);var n=h(3,7);var r=this.newRoom(Math.floor(this.w/2-t/2),Math.floor(this.h/2-n/2),t,n);r.corridor=0;this.planRoom(r);this.carve(r)}else{if(this.newRandomRoom()==0)e++}if(e>0)this.stuck++;this.digs++;var i=0;if(this.tilesDug>=this.tiles*this.fillRatio)i=1;if(this.stuck>100)i=1;if(i==1){for(var s=0;s<10;s++){var o=this.newRandomRoom({corridor:0,w:h(3,7),h:h(3,7)});if(o!=0&&o.freeTiles>15)break}}Math.seedrandom();if(i==1)return 1;else if(e>0)return-1;else return 0};this.Map.prototype.finish=function(){for(var e in this.rooms){var t=Math.random()<this.pillarRatio;for(var o in this.rooms[e].tiles){var c=this.rooms[e].tiles[o].x;var h=this.rooms[e].tiles[o].y;var p=this.data[c][h][0];var d=this.data[c-1][h][0];var v=this.data[c+1][h][0];var m=this.data[c][h-1][0];var g=this.data[c][h+1][0];var y=this.data[c-1][h-1][0];var b=this.data[c+1][h-1][0];var w=this.data[c-1][h+1][0];var E=this.data[c+1][h+1][0];var S=0;if(d==u||d==a)S++;if(m==u||m==a)S++;if(v==u||v==a)S++;if(g==u||g==a)S++;if(y==u||y==a)S++;if(b==u||b==a)S++;if(w==u||w==a)S++;if(E==u||E==a)S++;var x=0;if(d==r||d==n)x++;if(m==r||m==n)x++;if(v==r||v==n)x++;if(g==r||g==n)x++;if(y==r||y==n)x++;if(b==r||b==n)x++;if(w==r||w==n)x++;if(E==r||E==n)x++;var T=0;if(S+x==8)T=1;var N=0;if(T){var C=0;var k=0;var L=0;var A=0;if((y==u||y==a)&&(m==u||m==a)&&(b==u||b==a))C=1;else if((y==r||y==n)&&(m==r||m==n)&&(b==r||b==n))C=-1;if((b==u||b==a)&&(v==u||v==a)&&(E==u||E==a))L=1;else if((b==r||b==n)&&(v==r||v==n)&&(E==r||E==n))L=-1;if((y==u||y==a)&&(d==u||d==a)&&(w==u||w==a))k=1;else if((y==r||y==n)&&(d==r||d==n)&&(w==r||w==n))k=-1;if((w==u||w==a)&&(g==u||g==a)&&(E==u||E==a))A=1;else if((w==r||w==n)&&(g==r||g==n)&&(E==r||E==n))A=-1;if(C==1&&A==-1||C==-1&&A==1||k==1&&L==-1||k==-1&&L==1)N=1}if(t&&Math.random()<.8&&this.rooms[e].freeTiles>4){if((N==1||T&&S==7)&&p==n&&d!=i&&v!=i&&m!=i&&g!=i){this.data[c][h][0]=s;p=s;this.removeFreeTile(c,h);this.rooms[e].freeTiles--}}if(C==1||A==1||k==1||L==1){this.rooms[e].tiles[o].score+=2}if(S>5||x>5){this.rooms[e].tiles[o].score+=1}if(S==7||x==8){this.rooms[e].tiles[o].score+=5}if(p!=r&&p!=n||d==i||v==i||m==i||g==i)this.rooms[e].tiles[o].score=-1}}var O=this.getBestSpotInRoom(this.getEarliestRoom());this.data[O.x][O.y][0]=f;this.entrance=[O.x,O.y];O.score=0;this.removeFreeTile(O.x,O.y);var M=this.getBestSpotInRoom(this.getDeepestRoom());this.data[M.x][M.y][0]=l;this.exit=[M.x,M.y];this.removeFreeTile(M.x,M.y);M.score=0};this.Map.prototype.isObstacle=function(e,t){var s=[n,r,i,f,l];for(var o in s){if(this.data[e][t][0]==s[o])return 0}return 1};var m=function(e,t,n,r){var i=1;var s=e.data[t][n][0];var o=e.data[t-1][n][0];var u=e.data[t+1][n][0];var a=e.data[t][n-1][0];var f=e.data[t][n+1][0];r.push(s);var l=0;for(var c in r){if(o==r[c])l++;if(u==r[c])l++}var h=0;for(var c in r){if(a==r[c])h++;if(f==r[c])h++}if(l==2&&h==2)i=1;else if(l==2)i=2;else if(h==2)i=3;return i};this.Map.prototype.getPic=function(e,t){if(g[this.data[e][t][2]]){if(g[this.data[e][t][2]].joinType=="join"){var n=g[this.data[e][t][2]].pic;n=[n[0],n[1]];var r=[];if(this.data[e][t][0]==u)r.push(a);else if(this.data[e][t][0]==i)r.push(u,a);n[0]+=m(this,e,t,r)-1;return n}else if(g[this.data[e][t][2]].joinType=="random3"){var n=g[this.data[e][t][2]].pic;n=[n[0],n[1]];n[0]+=Math.floor(Math.random()*3);return n}return g[this.data[e][t][2]].pic}return[0,0]};var g=[];var y=[];this.Tile=function(e,t,n){this.name=e;this.pic=t;this.joinType=n||"none";this.id=g.length;g[this.id]=this;y[this.name]=this};new this.Tile("void",[0,0]);this.loadTiles=function(e){for(var t in e){var n=e[t][0];var r=e[t][1];var i=e[t][2];new this.Tile(n,r,i)}};var b=function(e,t,n,r){if(e==n&&t[r])return y[t[r]];return 0};this.Map.prototype.assignTiles=function(e,t){for(var c in e.tiles){var h=g[0];var p=e.tiles[c];var d=this.data[p.x][p.y][0];h=b(d,t,a,"wall corner")||h;h=b(d,t,u,"wall")||h;h=b(d,t,n,"floor edges")||h;h=b(d,t,r,"floor")||h;h=b(d,t,s,"pillar")||h;h=b(d,t,i,"door")||h;h=b(d,t,o,"water")||h;h=b(d,t,f,"entrance")||h;h=b(d,t,l,"exit")||h;this.data[p.x][p.y][2]=h.id}};this.Map.prototype.draw=function(e){var t="";var e=e||10;for(var n=0;n<this.h;n++){for(var r=0;r<this.w;r++){var i="";if(this.isFloor(r,n)!=-1)i="o";if(this.isWall(r,n)!=-1)i+="x";var s=this.getRoom(r,n);var o=Math.max(.1,1-this.getRoom(r,n).gen/10);var u=s.freeTiles;i="";t+='<div style="opacity:'+o+";width:"+e+"px;height:"+e+"px;position:absolute;left:"+r*e+"px;top:"+n*e+"px;display:block;padding:0px;margin:0px;background:#"+c[this.data[r][n][0]]+';color:#999;" title="'+u+'">'+i+"</div>"}t+="<br>"}t='<div style="position:relative;width:'+this.w*e+"px;height:"+this.h*e+"px;background:#000;font-family:Courier;font-size:"+e+'px;float:left;margin:10px;">'+t+"</div>";return t};this.Map.prototype.drawDetailed=function(){var e="";var t=16;for(var n=0;n<this.h;n++){for(var r=0;r<this.w;r++){var i=this.getRoom(r,n);var s=1;var o="void";if(i!=-1){s=Math.max(.1,1-i.gen/5);if(this.data[r][n][0]==f||this.data[r][n][0]==l)s=1;o=(i.corridor?"corridor":"room")+" "+i.id+" | depth : "+i.gen+" | children : "+i.children.length}var u=this.getPic(r,n);e+='<div style="opacity:'+s+";width:"+t+"px;height:"+t+"px;position:absolute;left:"+r*t+"px;top:"+n*t+"px;display:block;padding:0px;margin:0px;background:#"+c[this.data[r][n][0]]+" url(img/dungeonTiles.png) "+ -u[0]*16+"px "+ -u[1]*16+'px;color:#999;" title="'+o+'"></div>'}e+="<br>"}e='<div style="box-shadow:0px 0px 12px 6px #00061b;position:relative;width:'+this.w*t+"px;height:"+this.h*t+"px;background:#00061b;font-family:Courier;font-size:"+t+'px;float:left;margin:10px;">'+e+"</div>";return e};this.Map.prototype.getStr=function(){var e="";var t=16;for(var n=0;n<this.h;n++){for(var r=0;r<this.w;r++){var i=this.getRoom(r,n);var s=1;var o="void";var u=this.getPic(r,n);if(i!=-1){if(i.hidden)u=[0,0];o=(i.corridor?"corridor":"room")+" "+i.id+" | depth : "+i.gen+" | children : "+i.children.length}e+='<div style="opacity:'+s+";width:"+t+"px;height:"+t+"px;position:absolute;left:"+r*t+"px;top:"+n*t+"px;display:block;padding:0px;margin:0px;background:#"+c[this.data[r][n][0]]+" url(img/dungeonTiles.png) "+ -u[0]*16+"px "+ -u[1]*16+'px;color:#999;" title="'+o+'"></div>'}e+="<br>"}return e}}