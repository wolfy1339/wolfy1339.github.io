/*Orteil's sloppy Cookie Clicker dungeons
Optimizations to do (not mentioning the dozens of missing features) :
-use canvas instead
-only compute AI for mobs with 2 tiles of view*/
var LaunchDungeons=function(){Game.GetWord=function(e){if(e=="secret")return choose(["hidden","secret","mysterious","forgotten","forbidden","lost","sunk","buried","concealed","shrouded","invisible","elder"]);if(e=="ruined")return choose(["ancient","old","ruined","ravaged","destroyed","collapsed","demolished","burnt","torn-down","shattered","dilapidated","abandoned","crumbling","derelict","decaying"]);if(e=="magical")return choose(["arcane","magical","mystical","sacred","honed","banished","unholy","holy","demonic","enchanted","necromantic","bewitched","haunted","occult","astral"]);return""};Game.DungeonTypes=[];Game.DungeonType=function(e){this.name=e;this.nameGenerator=function(){return"Mysterious dungeon"};this.roomTypes=[];Game.DungeonTypes[this.name]=this;return this};(new Game.DungeonType("Factory")).nameGenerator=function(){var e="";e+=Game.GetWord(choose(["secret","ruined","magical"]))+" "+choose(["factory","factories","bakery","bakeries","confectionery","laboratory","research center","chocolate forge","chocolate foundry","manufactory","warehouse","machinery","works","bakeworks","workshop","assembly line"]);return e};(new Game.DungeonType("Mine")).nameGenerator=function(){var e="";e+=Game.GetWord(choose(["secret","ruined","magical"]))+" "+choose(["chocolate","chocolate","chocolate","white chocolate","sugar","cacao"])+" "+choose(["mine","mines","pit","pits","quarry","excavation","tunnel","shaft","lode","trench","mountain","vein","cliff","peak","dome","crater","abyss","chasm","hole","burrow"]);return e};(new Game.DungeonType("Portal")).nameGenerator=function(){var e="";e+=Game.GetWord(choose(["secret","ruined","magical"]))+" "+choose(["portal","gate","dimension","warpgate","door"]);return e};(new Game.DungeonType("Secret zebra level")).nameGenerator=function(){var e="";e+=Game.GetWord(choose(["secret"]))+" "+choose(["zebra level"]);return e};var e=new DungeonGen;e.loadTiles([["wall",[1,0],"join"],["wall corner",[1,0]],["floor",[1,1],"random3"],["tiled floor",[1,2],"join"],["round pillar",[1,4]],["square pillar",[2,4]],["potted plant",[3,4]],["bookshelf",[4,5],"join"],["door",[1,3],"join"],["alt wall",[4,0],"join"],["alt wall corner",[4,0]],["alt floor",[4,1],"random3"],["alt tiled floor",[4,2],"join"],["alt round pillar",[4,4]],["alt square pillar",[5,4]],["alt potted plant",[6,4]],["alt bookshelf",[4,6],"join"],["alt door",[4,3],"join"],["water",[1,5]],["green water",[2,5]],["dark water",[3,5]],["wooden wall",[1,7],"join"],["wooden floor",[1,6],"random3"],["conveyor belt",[4,7],"join"],["entrance",[0,1]],["alt entrance",[0,3]],["exit",[0,2]],["alt exit",[0,4]]]);Game.monsterIconY=10;Game.Monsters=[];Game.Monster=function(e,t,n,r,i,s){this.name=e;this.pic=t;this.icon=n;this.level=r;this.stats={};for(var o in i){this.stats[o]=i[o]}this.stats.hpm=this.stats.hp;this.stats.rarity=i.rarity||1;this.loot=s||{};this.boss=0;this.quotes={};Game.Monsters[this.name]=this};var t={cookies:{min:1,max:5,prob:.5}};var n={cookies:{min:3,max:8,prob:1},gear:{prob:.05}};var i={gear:{prob:1}};var s={cookies:{min:2,max:20,prob:1},gear:{prob:.1}};var i={cookies:{min:10,max:50,prob:1},gear:{prob:.2}};new Game.Monster("Doughling","doughling",[0,0],1,{hp:5,might:2,guard:2,speed:6,dodge:6,rarity:.7},t);new Game.Monster("Elder doughling","elderDoughling",[1,0],7,{hp:20,might:7,guard:7,speed:4,dodge:4,rarity:.7},n);new Game.Monster("Angry sentient cookie","angrySentientCookie",[5,0],5,{hp:16,might:8,guard:4,speed:5,dodge:5,rarity:1},t);new Game.Monster("Baby sentient cookie","babySentientCookie",[4,0],1,{hp:3,might:1,guard:1,speed:7,dodge:7,rarity:1},t);new Game.Monster("Burnt sentient cookie","burntSentientCookie",[6,0],5,{hp:16,might:12,guard:2,speed:3,dodge:2,rarity:.2},t);new Game.Monster("Raw sentient cookie","rawSentientCookie",[5,0],5,{hp:16,might:6,guard:4,speed:7,dodge:7,rarity:.2},t);new Game.Monster("Sugar bunny","sugarBunny",[8,0],5,{hp:10,might:3,guard:8,speed:12,dodge:9,rarity:.001},{cookies:{min:1e3,max:1e4}});Game.Monsters["Sugar bunny"].onKill=function(){Game.Win("Follow the white rabbit")};Game.Monsters["Sugar bunny"].AI="flee";new Game.Monster("Crazed kneader","crazedKneader",[0,2],6,{hp:18,might:6,guard:8,speed:3,dodge:2,rarity:.5},n);new Game.Monster("Crazed chip-spurter","crazedDoughSpurter",[0,2],6,{hp:15,might:6,guard:8,speed:5,dodge:3,rarity:.5},n);new Game.Monster("Alarm bot","alarmTurret",[3,2],2,{hp:6,might:3,guard:5,speed:8,dodge:8,rarity:.5},t);new Game.Monster("Chirpy","chirpy",[4,2],3,{hp:7,might:4,guard:6,speed:9,dodge:9,rarity:.01},{cookies:{min:500,max:5e3}});Game.Monsters["Chirpy"].onKill=function(){Game.Win("Chirped out")};Game.Monsters["Chirpy"].quotes={fight:"oh, hello <3"};new Game.Monster("Disgruntled worker","disgruntledWorker",[1,2],4,{hp:14,might:5,guard:5,speed:6,dodge:4,rarity:.6},t);new Game.Monster("Disgruntled overseer","disgruntledOverseer",[1,2],7,{hp:22,might:7,guard:5,speed:6,dodge:4,rarity:.5},t);new Game.Monster("Disgruntled cleaning lady","disgruntledCleaningLady",[2,2],4,{hp:13,might:4,guard:5,speed:7,dodge:6,rarity:.3},t);new Game.Monster("Sentient Furnace","sentientFurnace",[0,3],0,{hp:60,might:14,guard:12,speed:4,dodge:0,rarity:1},i);Game.Monsters["Sentient Furnace"].onKill=function(){Game.Win("Getting even with the oven")};Game.Monsters["Sentient Furnace"].AI="static";Game.Monsters["Sentient Furnace"].boss=1;Game.Monsters["Sentient Furnace"].quotes={fight:"YOU ARE NOT READY!",defeat:"OH... BURN."};new Game.Monster("Ascended Baking Pod","ascendedBakingPod",[1,3],0,{hp:60,might:12,guard:14,speed:4,dodge:0,rarity:.7},i);Game.Monsters["Ascended Baking Pod"].onKill=function(){Game.Win("Now this is pod-smashing")};Game.Monsters["Ascended Baking Pod"].AI="static";Game.Monsters["Ascended Baking Pod"].boss=1;Game.Monsters["Ascended Baking Pod"].quotes={fight:"rrrrrrrise.",defeat:"blrglblg."};Game.BossMonsters=[];for(var o in Game.Monsters){if(Game.Monsters[o].boss)Game.BossMonsters.push(Game.Monsters[o])}Game.Entity=function(e,t,n,r,i){this.type=e;this.subtype=t||"";this.dungeon=n;this.pic=r||[0,0];this.stats={};for(var s in i){this.stats[s]=i[s]}this.x=-1;this.y=-1;this.obstacle=0;this.zIndex=1;if(this.type=="monster"){this.obstacle=1;this.pic=[Game.Monsters[this.subtype].icon[0],Game.Monsters[this.subtype].icon[1]];this.pic[1]+=Game.monsterIconY;this.targets=[];this.stuck=0;this.zIndex=10;this.fighting=0;this.AI=Game.Monsters[this.subtype].AI||"normal";this.onKill=Game.Monsters[this.subtype].onKill||function(){};for(var s in Game.Monsters[this.subtype].stats){this.stats[s]=Game.Monsters[this.subtype].stats[s]}}else if(this.type=="hero"){this.obstacle=1;this.pic=[Game.Heroes[this.subtype].icon[0],Game.Heroes[this.subtype].icon[1]];this.targets=[];this.stuck=0;this.zIndex=100;this.fighting=0;for(var s in Game.Heroes[this.subtype].stats){this.stats[s]=Game.Heroes[this.subtype].stats[s]}var o=Math.max(0,Game.Objects[this.dungeon.type].amount/20-1);this.stats.hpm+=Math.ceil(o*2);this.stats.hp=this.stats.hpm;this.stats.might+=o;this.stats.guard+=o;this.stats.speed+=o;this.stats.dodge+=o}else if(this.type=="item"){this.zIndex=5;this.value=0}else if(this.type=="destructible"){this.obstacle=1;this.life=3;this.zIndex=15;if(this.subtype=="door")this.pic=[0,7];else this.pic=[Math.floor(Math.random()*4+2),7];this.onKill=function(){if(this.subtype=="random"){var e=Math.round(Math.pow(Math.random(),6)*(10+this.dungeon.level));if(e>0){var t=this.dungeon.AddEntity("item","cookies",this.x,this.y);t.value=e}}}}else if(this.type=="special"){this.zIndex=5;this.value="";this.obstacle=1}this.Say=function(e){if(this.type=="monster"){if(Game.Monsters[this.subtype].quotes[e])this.dungeon.Log(this.subtype+' : "<span style="color:#f96;">'+choose(Game.Monsters[this.subtype].quotes[e].split("|"))+'</span>"')}};this.Draw=function(){var e="?";if(this.subtype=="random")e="clutter";else e=this.subtype;if(this.type=="item"&&this.subtype=="cookies"&&this.value>0){if(this.value<2)this.pic=[0,5];else if(this.value<3)this.pic=[1,5];else if(this.value<4)this.pic=[2,5];else if(this.value<6)this.pic=[3,5];else if(this.value<10)this.pic=[4,5];else if(this.value<20)this.pic=[5,5];else if(this.value<30)this.pic=[7,5];else if(this.value<70)this.pic=[6,5];else if(this.value<200)this.pic=[8,5];else this.pic=[6,6]}else if(this.type=="special"&&this.subtype=="upgrade"){if(this.value!="")this.pic=[7,6];else this.pic=[8,6]}return'<div class="thing" title="'+e+'" style="z-index:'+(200+this.zIndex)+";left:"+this.x*16+"px;top:"+this.y*16+"px;background-position:"+ -this.pic[0]*16+"px "+ -this.pic[1]*16+'px;"></div>'};this.Wander=function(){this.targets=[];this.targets.push([-1,0],[1,0],[0,-1],[0,1]);this.Move()};this.GoTo=function(e,t){this.targets=[];if(this.x<e)this.targets.push([1,0]);if(this.x>e)this.targets.push([-1,0]);if(this.y<t)this.targets.push([0,1]);if(this.y>t)this.targets.push([0,-1]);if(!this.Move()){this.targets=[];if(this.x==e)this.targets.push([1,0],[-1,0]);if(this.y==t)this.targets.push([0,1],[0,-1]);this.Move()}};this.Flee=function(e,t){this.targets=[];if(this.x>e)this.targets.push([1,0]);if(this.x<e)this.targets.push([-1,0]);if(this.y>t)this.targets.push([0,1]);if(this.y<t)this.targets.push([0,-1]);if(!this.Move()){this.targets=[];if(this.x==e)this.targets.push([1,0],[-1,0]);if(this.y==t)this.targets.push([0,1],[0,-1]);this.Move()}};this.Move=function(){if(this.targets.length>0){var e=[];if(this.type=="hero")e=this.targets;else{for(var t in this.targets){var n=this.targets[t];if(this.dungeon.CheckObstacle(this.x+n[0],this.y+n[1])!=-1)e.push([n[0],n[1]])}}if(e.length>0){var r=choose(e);var i=this.dungeon.CheckObstacle(this.x+r[0],this.y+r[1]);if(i==this)i=0;if(i==0&&this.AI!="static"){this.x+=r[0];this.y+=r[1]}else this.stuck+=2;if(i!=0&&i!=-1){i.HitBy(this)}if(i==-1)return 0}else{this.stuck+=2;return 0}if(this.AI=="static")this.stuck=0;return 1}return 0};this.HitBy=function(e){if(this.type=="destructible"&&e.type=="hero"){e.stuck=0;this.life--;if(this.life<=0){if(this.onKill)this.onKill();this.Destroy()}else this.pic=[this.pic[0],this.pic[1]+1]}else if(this.type=="special"&&this.subtype=="upgrade"){this.obstacle=0;if(Game.Upgrades[this.value])Game.Upgrades[this.value].earn();this.value=""}else if(this.type=="monster"&&e.type=="hero"||this.type=="hero"&&e.type=="monster"&&this.stats.hp>0){e.stuck=0;var t=this.type=="hero"?e:this;var n=this.type=="hero"?this:e;this.dungeon.currentOpponent=t;if(t.fighting==0){Game.Heroes[n.subtype].Say("meet "+Game.Monsters[t.subtype].name);this.Say("fight")}if(this.fighting==0){this.fighting=1;e.fighting=1}var r="";var i="";var s="";if(e.type=="hero")i=Game.Heroes[e.subtype].name;else if(e.type=="monster")i=Game.Monsters[e.subtype].name;if(this.type=="hero")s=Game.Heroes[this.subtype].name;else if(this.type=="monster")s=Game.Monsters[this.subtype].name;r+=i+" swings at "+s+"!";var o=Math.round(Math.max(1,Math.min(e.stats.might,Math.pow((e.stats.might+2.5)/Math.max(1,this.stats.guard),2)))*(.8+Math.random()*.4+Math.pow(Math.random()*.8,6)));var u=Math.random()>e.stats.speed/Math.max(1,this.stats.dodge+2.5);if(u){r+=" "+s+" dodged the attack."}else{if(e.stats.luck&&e.type=="hero"&&Math.random()<e.stats.luck*.01){o*=2;r+=" <b>It's a critical!</b>"}r+=" <b>"+o+"</b> damage!";this.stats.hp-=o;this.stats.hp=Math.max(this.stats.hp,0);if(this.stats.luck&&this.type=="hero"){if(this.stats.hp==0&&Math.random()<this.stats.luck*.01){this.stats.hp=1;r+=" "+s+" was saved from certain death!"}}}if(this.type=="hero")r='<span style="color:#f99;">'+r+"</span>";if(r!="")this.dungeon.Log(r);if(this.stats.hp<=0){this.dungeon.Log(i+" crushed "+s+"!");if(this.type=="hero"){Game.Heroes[this.subtype].Say("defeat");this.dungeon.Log('<span style="color:#f66;">'+Game.Heroes[this.subtype].name+" has been defeated.</span>");this.dungeon.FailLevel()}if(this.type=="monster"&&e.type=="hero"){l("monsterSlot"+this.dungeon.id).style.visibility="hidden";this.dungeon.monstersKilledThisRun+=1;if(Math.random()<.05)Game.Heroes[e.subtype].Say("win");Game.Heroes[e.subtype].Say("win against "+Game.Monsters[this.subtype].name);this.Say("defeat");if(Game.Monsters[this.subtype].loot){var a=Game.Monsters[this.subtype].loot;if(a.gear&&(!a.gear.prob||Math.random()<a.gear.prob)){}if(a.cookies&&(!a.cookies.prob||Math.random()<a.cookies.prob)){var f=this.dungeon.AddEntity("item","cookies",this.x,this.y);f.value=Math.round(a.cookies.min+Math.random()*(a.cookies.max-a.cookies.min))}}if(this.onKill)this.onKill();this.Destroy()}}}};this.Turn=function(){if(this.type=="monster"){var e=this.GetInitiative();for(var t=0;t<e;t++){if(1==1){if(this.AI=="flee")this.Flee(this.dungeon.heroEntity.x,this.dungeon.heroEntity.y);else{this.GoTo(this.dungeon.heroEntity.x,this.dungeon.heroEntity.y);if(this.stuck||this.targets.length==[])this.Wander()}}}}if(this.type=="monster"||this.type=="hero"){if(this.stuck>0)this.stuck--;this.stuck=Math.min(10,this.stuck);this.targets=[]}if((this.type=="hero"||this.type=="monster")&&this.fighting==0&&this.stats.hp<this.stats.hpm)this.stats.hp++;if(this.type=="hero"){var n=this.dungeon.GetEntities(this.x,this.y);for(var t in n){if(n[t].type=="item"&&n[t].subtype=="cookies"){var r=n[t];var i=Math.ceil(r.value*Game.Objects[this.dungeon.type].amount*50*(1+Math.random()*(this.stats.luck/20)));if(i>0){this.dungeon.Log('<span style="color:#9f9;">Found <b>'+Beautify(i)+"</b> cookie"+(i==1?"":"s")+"!</span>");this.dungeon.cookiesMadeThisRun+=i;Game.Earn(i)}r.Destroy()}}}if(this.type=="hero")this.fighting=0};this.Destroy=function(){this.dungeon.entities.splice(this.dungeon.entities.indexOf(this),1)};this.GetInitiative=function(){return randomFloor(this.stats.speed/5*(1/Math.max(1,this.dungeon.heroEntity.stats.speed/5)))}};Game.Dungeons=[];Game.Dungeon=function(t,n){this.type=t;this.id=n;Game.Dungeons[this.id]=this;this.log=[];this.logNew=0;this.name=Game.DungeonTypes[this.type].nameGenerator();this.hero=null;this.currentOpponent=0;this.level=0;this.auto=1;this.portalPic="";this.cookiesMadeThisRun=0;this.monstersKilledThisRun=0;this.Log=function(e,t){if(typeof e==="string"){this.log.unshift(e);this.logNew++}else{for(var n in e){this.Log(e[n],1)}}};this.UpdateLog=function(){this.log=this.log.slice(0,30);var e="";for(var t in this.log){if(t<this.logNew)e+='<div class="new">'+this.log[t]+"</div>";else e+="<div>"+this.log[t]+"</div>"}this.logNew=0;l("dungeonLog"+this.id).innerHTML=e};this.entities=[];this.GetEntities=function(e,t){var n=[];for(var r in this.entities){if(this.entities[r].x==e&&this.entities[r].y==t)n.push(this.entities[r])}return n};this.AddEntity=function(e,t,n,r){var i=new Game.Entity(e,t,this);i.x=n;i.y=r;i.dungeon=this;this.entities.push(i);return i};this.RemoveEntities=function(e,t){var n=this.GetEntities(e,t);for(var r in n){n[r].Destroy()}};this.DrawEntities=function(){var e="";for(var t in this.entities){e+=this.entities[t].Draw()}return e};this.CheckObstacle=function(e,t){if(e<0||e>=this.map.w||t<0||t>=this.map.h)return-1;var n=this.GetEntities(e,t);for(var r in n){if(n[r].obstacle)return n[r]}return this.map.isObstacle(e,t)?-1:0};this.map={};this.Generate=function(){if(this.level==0)this.name=Game.DungeonTypes[this.type].nameGenerator();this.entities=[];var t=new e.Map(40,40,Math.random(),{roomSize:10,corridorSize:5,fillRatio:1/2,corridorRatio:.3,pillarRatio:Math.random()*.8+.2,waterRatio:Math.random(),branching:Math.ceil(Math.random()*6),sizeVariance:.4});r=0;while(r!=1){r=t.dig()}t.finish();for(var n in t.doors){this.AddEntity("destructible","door",t.doors[n][0],t.doors[n][1])}for(var n in t.rooms){var i=choose(["alt ","",""]);var s={"void":i+"void",wall:i+"wall","wall corner":i+"wall corner",floor:i+"tiled floor","floor edges":i+"floor",door:i+"door",water:choose(["water","green water","dark water"]),pillar:choose([i+"wall",i+"round pillar",i+"square pillar",i+"potted plant","conveyor belt"]),entrance:i+"entrance",exit:i+"exit"};if(Math.random()<.1){s["wall corner"]="wooden wall";s["wall"]="wooden wall";s["floor edges"]="wooden floor";s["pillar"]="wooden wall"}if(Math.random()<.1){s["wall corner"]=i+"bookshelf";s["wall"]=i+"bookshelf";s["pillar"]=i+"bookshelf"}t.assignTiles(t.rooms[n],s)}this.map=t;this.map.str=this.map.getStr();var o=this.map.exit;var u=[];for(var a in Game.BossMonsters){var f=Game.BossMonsters[a];if(f.level<=c+this.level&&Math.random()<(f.stats.rarity||1))u.push(f.name)}if(u.length==0)u=[choose(Game.BossMonsters).name];if(u.length>0){this.AddEntity("monster",choose(u),o[0],o[1]);this.map.removeFreeTile(o[0],o[1])}for(var n=0;n<Math.ceil(this.map.freeTiles.length*.7);n++){var o=choose(this.map.freeTiles);if(o!=-1){var l=this.map.getRoom(o[0],o[1]);var c=l.gen+1;if(Math.random()<.2){var u=[];for(var a in Game.Monsters){var f=Game.Monsters[a];if(f.level!=0&&f.level<=c+this.level&&Math.random()<(f.stats.rarity||1))u.push(f.name)}if(u.length>0){this.AddEntity("monster",choose(u),o[0],o[1]);this.map.removeFreeTile(o[0],o[1])}}else{if(Math.random()<.6){var h=Math.round(Math.pow(Math.random(),6)*(10+this.level));if(h>0){var p=this.AddEntity("item","cookies",o[0],o[1]);p.value=h}}else this.AddEntity("destructible","random",o[0],o[1]);this.map.removeFreeTile(o[0],o[1])}}}};this.onTile=-1;this.Draw=function(){var e="";var t=-this.hero.x;var n=-this.hero.y;e+='<div id="map'+this.id+'" class="map" style="width:'+9*16+"px;height:"+9*16+'px;"><div class="mapContainer" id="mapcontainer'+this.id+'" style="position:absolute;left:'+t*16+"px;top:"+n*16+'px;"><div id="mapitems'+this.id+'"></div>'+this.map.str+"</div></div>";e+='<div style="position:absolute;left:'+(9*16+16)+'px;">'+'<a class="control west" onclick="Game.HeroesById['+this.hero.id+'].Move(-1,0);"></a><br>'+'<a class="control east" onclick="Game.HeroesById['+this.hero.id+'].Move(1,0);"></a><br>'+'<a class="control north" onclick="Game.HeroesById['+this.hero.id+'].Move(0,-1);"></a><br>'+'<a class="control south" onclick="Game.HeroesById['+this.hero.id+'].Move(0,1);"></a><br>'+'<a class="control middle" onclick="Game.HeroesById['+this.hero.id+'].Move(0,0);"></a><br>'+"</div>";e+='<div style="position:absolute;left:'+(9*16+16+48*3)+'px;bottom:16px;height:100%;">'+'<div class="dungeonName"><a onclick="Game.ObjectsById['+this.id+'].setSpecial(0);">Exit</a> - <span class="title" style="font-size:12px;">'+this.name+"</span> lvl."+(this.level+1)+"</div>"+'<div id="heroSlot'+this.id+'" class="mobSlot"><div id="picHero'+this.id+'" class="mobPic"></div><div id="nameHero'+this.id+'" class="title mobName"></div><div class="hpmBar"><div id="hpHero'+this.id+'" class="hpBar"></div></div></div>'+'<div id="monsterSlot'+this.id+'" class="mobSlot" style="left:128px;"><div id="picMonster'+this.id+'" class="mobPic"></div><div id="nameMonster'+this.id+'" class="title mobName"></div><div class="hpmBar"><div id="hpMonster'+this.id+'" class="hpBar"></div></div></div>'+"</div>"+'<div id="dungeonLog'+this.id+'" class="dungeonLog"></div>';l("rowSpecial"+this.id).innerHTML='<div style="width:100%;height:100%;z-index:10000;position:absolute;left:0px;top:0px;">'+e+"</div>";l("picHero"+this.id).style.backgroundImage="url(img/"+this.hero.portrait+".png)";l("nameHero"+this.id).innerHTML=this.hero.name};this.Refresh=function(){if(!l("mapcontainer"+this.id))this.Draw();var e=4-this.hero.x;var t=4-this.hero.y;l("mapcontainer"+this.id).style.left=e*16+"px";l("mapcontainer"+this.id).style.top=t*16+"px";l("mapitems"+this.id).innerHTML=this.DrawEntities()};this.RedrawMap=function(){this.map.str=this.map.getStr();this.Draw()};this.Turn=function(){for(var e in this.entities){if(this.entities[e]&&this.entities[e].type)this.entities[e].Turn()}if(this.currentOpponent){l("monsterSlot"+this.id).style.visibility="visible";l("hpMonster"+this.id).style.width=Math.round(this.currentOpponent.stats.hp/this.currentOpponent.stats.hpm*100)+"%";l("picMonster"+this.id).style.backgroundImage="url(img/"+Game.Monsters[this.currentOpponent.subtype].pic+".png)";l("nameMonster"+this.id).innerHTML=Game.Monsters[this.currentOpponent.subtype].name;l("picHero"+this.id).style.backgroundImage="url(img/"+this.hero.pic+".png)"}else{l("monsterSlot"+this.id).style.visibility="hidden";l("hpMonster"+this.id).style.width="100%";l("picHero"+this.id).style.backgroundImage="url(img/"+this.hero.portrait+".png)"}this.currentOpponent=0;l("hpHero"+this.id).style.width=Math.round(this.heroEntity.stats.hp/this.heroEntity.stats.hpm*100)+"%";this.Refresh();this.UpdateLog();if(this.hero.x==this.map.exit[0]&&this.hero.y==this.map.exit[1]){this.CompleteLevel()}};this.DrawButton=function(){var e="";e+='<div style="width:144px;height:144px;position:absolute;left:0px;bottom:0px;"><a class="specialButtonPic" style="background-image:url(img/'+this.portalPic+'.png);" onclick="Game.ObjectsById['+this.id+'].setSpecial(1);"><div class="specialButtonText">Enter dungeons</div></a></div>';return e};this.CompleteLevel=function(){this.hero.Say("completion");this.level++;this.Generate();Game.HeroesById[0].EnterDungeon(this,this.map.entrance[0],this.map.entrance[1]);this.Draw()};this.FailLevel=function(){this.Log("Cookies made this run : "+Beautify(this.cookiesMadeThisRun)+" | Monsters defeated this run : "+Beautify(this.monstersKilledThisRun));this.cookiesMadeThisRun=0;this.monstersKilledThisRun=0;this.level=0;this.Generate();Game.HeroesById[0].EnterDungeon(this,this.map.entrance[0],this.map.entrance[1]);this.Draw()}};Game.DungeonLocationChain=function(e,t,n){var r=e.getRoom(t,n);var i=[];if(r!=-1){while(r.parent){i.push(r);r=r.parent}}i.reverse();return i};Game.DungeonLinkLocationChains=function(e,t){e.reverse();t.reverse();if(e[0].id==t[0].id)return e[e.length-1];for(var n in t){if(e[0]==t[n].parent)return t[n]}if(e.length>1)return e[1];return e[0]};Game.Objects["Factory"].special=function(){this.dungeon=new Game.Dungeon("Factory",this.id);this.dungeon.Generate();this.specialDrawFunction=function(){this.dungeon.Refresh()};this.drawSpecialButton=function(){return this.dungeon.DrawButton()};this.dungeon.timer=0;this.dungeon.timerWarmup=5;this.dungeon.portalPic="dungeonFactory";this.EachFrame=function(){if(this.dungeon.auto){if(this.dungeon.timer>0)this.dungeon.timer--;if(this.dungeon.timer==0){this.dungeon.timer=Game.fps*(Math.max(.1,2-this.dungeon.hero.stats.speed*.2)+Math.max(this.dungeon.timerWarmup,0));if(this.dungeon.timerWarmup>0)this.dungeon.timerWarmup--;var e=this.dungeon;var t=e.heroEntity;var n=Game.DungeonLinkLocationChains(Game.DungeonLocationChain(e.map,t.x,t.y),Game.DungeonLocationChain(e.map,e.map.exit[0],e.map.exit[1]));var r=n.gen==0||n.id==e.map.getRoom(t.x,t.y).id?[e.map.exit[0],e.map.exit[1]]:n.door;t.GoTo(r[0],r[1]);if(t.stuck)t.Wander();e.hero.x=t.x;e.hero.y=t.y;e.Turn()}}};if(document.addEventListener){l("rowSpecial"+this.dungeon.id).removeEventListener("keydown",arguments.callee,false);l("rowSpecial"+this.dungeon.id).addEventListener("keydown",function(e){var t=Game.Objects["Factory"].dungeon;var n=0;if(e.keyCode==37){t.hero.Move(-1,0);n=1}else if(e.keyCode==38){t.hero.Move(0,-1);n=1}else if(e.keyCode==39){t.hero.Move(1,0);n=1}else if(e.keyCode==40){t.hero.Move(0,1);n=1}else if(e.keyCode==32){t.hero.Move(0,0);n=1}else if(e.keyCode==65){if(t.auto){t.auto=0;t.timerWarmup=-1}else{t.auto=1;t.timer=0;t.timerWarmup=0}e.preventDefault()}if(n){e.preventDefault();t.timer=Game.fps*10;t.timerWarmup=5}})}var e=choose(Game.HeroesById);e.EnterDungeon(this.dungeon,this.dungeon.map.entrance[0],this.dungeon.map.entrance[1])};Game.Heroes=[];Game.HeroesById=[];Game.Hero=function(e,t,n,r){this.name=e;this.pic=t;this.portrait=n;this.icon=r;this.stats={hp:25,hpm:25,might:5,guard:5,speed:5,dodge:5,luck:5};this.dialogue={greeting:"Oh hey.|Sup.",entrance:"Here we go.|So exciting.",completion:"That was easy.|All done here.",defeat:"Welp.|Better luck next time."};this.gear={armor:-1,weapon:-1};this.inDungeon=-1;this.completedDungeons=0;this.x=0;this.y=0;this.EnterDungeon=function(e,t,n){this.inDungeon=e.id;e.hero=this;this.x=t;this.y=n;e.heroEntity=e.AddEntity("hero",e.hero.name,t,n);var r=e.map.getRoom(this.x,this.y);if(r!=-1&&r.hidden){r.hidden=0;e.RedrawMap()}Game.Dungeons[this.inDungeon].Refresh();e.Log("--------------------");if(e.level==0)this.Say("greeting");this.Say("entrance");l("monsterSlot"+e.id).style.visibility="hidden"};this.Move=function(e,t){var n=Game.Dungeons[this.inDungeon];n.heroEntity.targets=[[e,t]];if(n.heroEntity.Move()){this.x=n.heroEntity.x;this.y=n.heroEntity.y;n.Turn()}};this.Say=function(e){if(this.dialogue[e])Game.Dungeons[this.inDungeon].Log(this.name+' : "<span style="color:#99f;">'+choose(this.dialogue[e].split("|"))+'</span>"')};this.save=function(){var e="";e+=this.inDungeon+","+this.completedDungeons+","+this.gear.armor+","+this.gear.weapon;return e};this.load=function(e){var t=e.split(",");this.inDungeon=parseInt(t[0]);this.completedDungeons=parseInt(t[1]);this.gear.armor=parseInt(t[2]);this.gear.weapon=parseInt(t[3])};this.id=Game.HeroesById.length;Game.HeroesById.push(this);Game.Heroes[this.name]=this};var u=new Game.Hero("Chip","girlscoutChip","portraitChip",[1,0]);u.dialogue={intro:"I'm Chip! I just really like exploring stuff. Let's go have an adventure!",greeting:"Hello there!|I'm ready!|Where are we going today?|Adventure!",win:"Take that!|Hah!|That's right.",entrance:"Chipping in!|Welp, here goes nothing!|I wonder what I'll find!|Hey, this place is new!|This place seems familiar.|Let's make it happen.",completion:"I'm one smart cookie.|Oh yeah!|Let's explore some more!|That was easy!|That sure was fun!|I'm not lost, am I?|More exploring? Sure, why not!",defeat:"B-better luck next time.|That really hurt!|I yield! I yield!|That went badly.|No half-baked excuses next time.|I think I scraped my knee!|Owie.|Woopsie!","win against Sentient Furnace":"The irony, it burns! (...it's funny because it was burning. And made of iron. ...Moving on.)","win against Ascended Baking Pod":"Where is your pod now?|That was disturbing."};u.stats={hp:30,hpm:30,might:5,guard:5,speed:5,dodge:5,luck:5};var u=new Game.Hero("Crumb","girlscoutCrumb","portraitCrumb",[2,0]);u.dialogue={intro:"I'm Crumb. I look like this because of a baking accident when I was little. Big deal. At least now I don't get hurt as easily as others, I guess.",greeting:"Hi there.|Ready for adventure, I guess.|Reporting for duty.",win:"Oh sorry, did that hurt?|Should have moved out of the way.|Oops. My bad.",entrance:"Let's do this, I guess.|Well, let's go...|I gotta go in there?|Are we really doing this?|I hope I won't get lost like last time.|Let's get this over with.",completion:"I... I did it...|I'm glad that's over.|What, there's more?|In I go, I guess.|It doesn't end, does it?|But it's dark in there.",defeat:"I, uh, ouch.|Why does that always happen to me?|I'm just no good, am I?|Oh no.|I'm... I'm not crying.|Well that wasn't fun at all.|I'm sorry I failed you.|Please... make them go away...","meet Ascended Baking Pod":"That thing shouldn't even be alive.|Is that where they all came from?","win against Ascended Baking Pod":"Hm. Fascinating."};u.stats={hp:25,hpm:25,might:5,guard:7,speed:4,dodge:4,luck:5};var u=new Game.Hero("Doe","girlscoutDoe","portraitDoe",[3,0]);u.dialogue={intro:"H-hey. Name's Doe. I'm pretty fast. I uh, I promise I'll do my best.",greeting:"H-hey.|Oh, uh, h-hi there.|C-can I join?",win:"Th-that looks like it hurt... awesome...|D-did I do that?|N-neat... there's pieces everywhere.",entrance:"Alright, let's do this!|I-if I really have to.|I-in there? By myself?|...won't you come with me this time?|H-here I go!",completion:"Oh... oh my.|That's... I uh, I'm glad.|Y-yeah that was real easy. Piece of pie!|T-too easy, right?|S-so many cookies...|Ooh? F-fascinating.",defeat:"I-if you can't beat them... join them.|I-it's because I stutter, isn't it?|W-well that's just no good at all.|I, uh, I meant for that to happen.|H-how embarrassing.","meet Ascended Baking Pod":"W-whoah... it's... magnificent...","win against Ascended Baking Pod":"I'm sorry, buddy.|I... I think I hurt it...|Oh no... I-I think I broke it..."};u.stats={hp:25,hpm:25,might:4,guard:4,speed:7,dodge:5,luck:5};var u=new Game.Hero("Lucky","girlscoutLucky","portraitLucky",[4,0]);u.dialogue={intro:"Oh joy! My name's Lucky. Guess what I'm good at?",greeting:"I'm feeling lucky!|It's a bright day today!|Let's do great things together.",win:"Ooh lucky shot!|Pow! One more.|Damn straight!",entrance:"Glad to be of service!|Oooh this one'll be interesting.|This will be a good one, I can feel it!|Here I come!",completion:"Over already?|Let's explore some more!|That was lucky!|That was no luck, I'm just that good.|Alright, let's move on!|I'm just getting warmed up!",defeat:"I can't believe it!|...This is a joke, right?|Hey! No fair!|B-but...|I'm gonna need a bandaid. And some hot chocolate.|I'll, uh, try again later.|Bad luck! Bad luck!","win against Ascended Baking Pod":"Golly, that was peculiar."};u.stats={hp:25,hpm:25,might:5,guard:4,speed:4,dodge:5,luck:7}}